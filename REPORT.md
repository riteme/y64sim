# y64 模拟器

<center>18307130172，薛振梁</center>

### 目录

* 文件目录结构
* 模拟器前端使用
* 实现的功能
    * 模拟器
    * 后端
    * 前端
* 代码架构
* 注意事项

### 文件目录结构

* `README.md`：模拟器运行指南。
* `REPORT.md`：本文档。
* `sim.py`：模拟器简单前端。
* `yas.py`：未完工的 `ys` 编译器。
* `test/`：`yo` 和 `ys` 测试文件。
* `core/`：模拟器核心模块。
* `pipeline/`：流水线架构实现模块。
    * `pipeline/instructions/`：流水线指令集实现。
* `backend/`：后端服务器网络接口代码。
* `frontend/`：前端代码。
    * `frontend/build/`：编译好的前端。

### 模拟器前端使用

按照 `README.md` 的指南启动好后端和前端后，后端默认地址为 `http://localhost:5000/`，前端默认地址为 `http://localhost:3000/`。进入前端可以看到右上角的文本框填写的默认后端地址也是一样的，正常情况下无需修改。地址文本框左边的图标指示当前输入的地址是否能够 `ping` 上。

主界面分为左右两边。左边有四个标签页，分别是 “代码”、“处理器状态”、“内存” 和 “设置”。代码编辑器下边栏左侧可以选择语言，虽然当前的后端暂时只支持 `yo` 语法，不支持 `ys` 语法。点击同一行右边的 “COMPILE & LOAD” 按钮可以编译和载入新编译好的程序。如果编译失败或者有编译警告生成，代码框下方会展示对应的错误和警告。点击错误和警告可以在代码编辑器中跳转到对应的行。

右侧最上方有四个控制按钮，分别是 “重置”、“启动/暂停”、“后退” 和 “前进”。中间是流水线的状态显示，每个收缩栏的标题写的是当前流水线阶段的名称和运行的指令，如果没有指令则显示 “`(no instruction)`”。每个收缩栏点开后可以看到流水线寄存器。最下方是前端/后端日志输出。如果程序运行中遇到异常或者退出，顶部栏会显示当前处理器的状态。

### 实现的功能
#### 模拟器

实现了所有的 y86-64 架构的基本功能：5 级流水线、寄存器、内存、条件代码。除了书上的基本指令集外，为了运行 `test/asumi.yo`，额外实现了 `iaddq`、`isubq`、`ixorq`、`iandq` 和 `iorq` 这五个指令。

流水线支持寄存器、内存读写冲突检测从而自动 stall 对应指令。流水线支持 data forwarding 至 DECODE 阶段。

模拟器代码架构提供了一个统一的接口来实现指令集，因此理论上可以按照需求任意添加新的指令。实现新指令时只要按照流水线硬件架构的约定来编写五个阶段的数据逻辑。流水线逻辑会处理所有的异常和 data forwarding。实现指令时不需要考虑操作是否合法。指令可以选择是否将当前阶段新计算出来的值 forward 到后面的阶段中。

默认情况下模拟器会限制处理器迭代次数（5000 次）和内存大小（8 KB）。

#### 后端

后端只是一个模拟器的 wrapper。用于提供网络 API。

目前提供的接口有：

* `parse`：解析 `yo` 和 `ys` 代码，返回编译后的字节序列（`ys` 代码的编译暂时不支持）。
* `initialize`：初始化程序。
* `simulate`：单步模拟。

#### 前端

提供基本的编写和检查功能，包括：

* 支持编写 `yo` 代码和编译报错、错误定位。
* 寄存器、内存内容查看。支持在内存中追踪 PC 的位置。对于内存和寄存器值相对于上一个周期变动的地方会高亮显示。
* 支持断点运行、单步前进、单步后退、重置来操作程序运行状态。运行过程中遇到异常会自动暂停。支持调控模拟时相邻两个时钟周期之间的间隔时间。
* 查看流水线五个阶段的状态。

### 代码架构

模拟器实际上是一个巨大的状态机架构。主要由三部分组成：

* `pipeline/impl.py`：流水线逻辑。
* `pipeline/proc.py`：处理器（`Processor`）状态。
* `pipeline/instructions/*.py`：指令集的实现。

流水线逻辑和指令集之间依靠 `Processor` 进行沟通。指令在运行过程中出现任何问题都直接交给流水线逻辑处理。

由于模拟器是以状态机的方式实现的，所以后端直接将 `Processor` 编码为 JSON 后与前端交互，实现前后端的分离。

### 注意事项

由于本模拟器的 `yo` 解析器是按照文件中使用到的最大地址来分配最大内存空间的，所以对于 `test/pushquestion.yo` 和 `test/prog5.yo` 需要在文件末尾添加：

```
0x200:  | max_address = 512
```

使得程序分配 512bytes 的空间，否则运行时会出现意外的 Memory Error。